document.addEventListener('DOMContentLoaded', function () { const $ = id => document.getElementById(id), trigger = $('see-it-trigger'), modal = $('see-it-modal'), closeBtn = document.querySelector('.see-it-close'), uploadInput = $('see-it-upload'), roomImage = $('see-it-room-image'), productImage = $('see-it-product-image'), generateBtn = $('see-it-generate'), resultDiv = $('see-it-result'), statusText = $('see-it-status'), maskUploadInput = $('see-it-mask-upload'), cleanRoomBtn = $('see-it-clean-room'), resetRoomBtn = $('see-it-reset-room'), scaleSlider = $('see-it-scale-slider'), scaleValue = $('see-it-scale-value'), adjustPlacementBtn = $('see-it-adjust-placement'), retryBtn = $('see-it-retry'), errorDiv = $('see-it-error'), actionsDiv = $('see-it-actions'), container = $('see-it-canvas-container'), saveRoomBtn = $('see-it-save-room'), savedRoomsList = $('see-it-saved-rooms-list'); let sessionId = null, originalRoomImageUrl = null, currentRoomImageUrl = null, currentScale = 1.0, lastPlacementPayload = null, isDragging = false, currentX, currentY, initialX, initialY, xOffset = 0, yOffset = 0; const getStorageKey = () => `see-it-saved-rooms:${window.Shopify.shop}`, getSavedRooms = () => JSON.parse(localStorage.getItem(getStorageKey()) || '[]'), saveRoom = name => { const saved = getSavedRooms(); saved.push({ id: sessionId, thumbnailUrl: currentRoomImageUrl, name }); localStorage.setItem(getStorageKey(), JSON.stringify(saved)); renderSavedRooms() }, loadRoom = roomId => { const saved = getSavedRooms(), room = saved.find(r => r.id === roomId); if (room) { sessionId = room.id; currentRoomImageUrl = room.thumbnailUrl; originalRoomImageUrl = room.thumbnailUrl; roomImage.src = room.thumbnailUrl; xOffset = 0; yOffset = 0; currentScale = 1.0; scaleSlider && (scaleSlider.value = 1.0); scaleValue && (scaleValue.textContent = '1.0'); applyTransform() } }, deleteRoom = roomId => { const saved = getSavedRooms().filter(r => r.id !== roomId); localStorage.setItem(getStorageKey(), JSON.stringify(saved)); renderSavedRooms() }, renderSavedRooms = () => { if (!savedRoomsList) return; const saved = getSavedRooms(); savedRoomsList.innerHTML = saved.length ? saved.map(r => `<div class="saved-room-item" style="display:flex;align-items:center;gap:10px;padding:8px;border:1px solid #ddd;margin-bottom:8px;cursor:pointer;border-radius:4px;"><img src="${r.thumbnailUrl}" alt="${r.name}" style="width:60px;height:60px;object-fit:cover;border-radius:4px;"><div style="flex:1;"><strong>${r.name}</strong></div><button onclick="event.stopPropagation();window.seeItDeleteRoom('${r.id}')" style="padding:4px 8px;background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;">Delete</button></div>`).join('') : '<p style="color:#999;text-align:center;padding:20px;">No saved rooms yet</p>'; document.querySelectorAll('.saved-room-item').forEach((el, i) => { el.addEventListener('click', () => loadRoom(saved[i].id)) }) }; window.seeItDeleteRoom = deleteRoom; const showError = msg => { errorDiv.textContent = msg; errorDiv.classList.remove('hidden') }, setTranslate = (x, y, el) => { el.style.transform = `translate3d(${x}px,${y}px,0) scale(${currentScale})` }, applyTransform = () => productImage && setTranslate(xOffset, yOffset, productImage), pollStatus = jobId => { const interval = setInterval(() => { fetch(`/apps/see-it/render/${jobId}`).then(res => { if (res.status === 429) { clearInterval(interval); showError('Daily quota exceeded. Please try again tomorrow or upgrade your plan.'); statusText.innerText = ''; return null } return res.json() }).then(data => { if (!data) return; if (data.status === 'completed') { clearInterval(interval); statusText.innerText = 'Done!'; const img = document.createElement('img'); img.src = data.imageUrl; img.style.width = '100%'; resultDiv.innerHTML = ''; resultDiv.appendChild(img); actionsDiv.classList.remove('hidden'); retryBtn.classList.add('hidden') } else if (data.status === 'failed') { clearInterval(interval); showError(data.errorMessage || 'Failed to generate image'); statusText.innerText = ''; actionsDiv.classList.remove('hidden'); retryBtn.classList.remove('hidden') } }).catch(err => { clearInterval(interval); console.error('Polling error:', err); showError('Error checking render status'); statusText.innerText = '' }) }, 2000) }; trigger && trigger.addEventListener('click', () => { modal.classList.remove('hidden'); fetch('/apps/see-it/room/start', { method: 'POST' }).then(res => res.json()).then(data => sessionId = data.sessionId).catch(err => console.error('Error starting session:', err)); productImage.src = trigger.dataset.productImage; renderSavedRooms() }); closeBtn && closeBtn.addEventListener('click', () => modal.classList.add('hidden')); uploadInput && uploadInput.addEventListener('change', e => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = e => { roomImage.src = e.target.result; $('see-it-step-1').classList.add('hidden'); $('see-it-step-2').classList.remove('hidden') }; reader.readAsDataURL(file); originalRoomImageUrl = currentRoomImageUrl = e.target.result } }); saveRoomBtn && saveRoomBtn.addEventListener('click', () => { const name = prompt('Enter a name for this room:'); if (name && sessionId && currentRoomImageUrl) { saveRoom(name); alert('Room saved!') } }); cleanRoomBtn && cleanRoomBtn.addEventListener('click', () => maskUploadInput.click()); maskUploadInput && maskUploadInput.addEventListener('change', async e => { const maskFile = e.target.files[0]; if (!maskFile || !sessionId) return; try { const maskStartRes = await fetch('/apps/see-it/room/mask-start', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ room_session_id: sessionId }) }), { upload_url, mask_image_url } = await maskStartRes.json(); await fetch(upload_url, { method: 'PUT', body: maskFile, headers: { 'Content-Type': maskFile.type } }); const cleanupRes = await fetch('/apps/see-it/room/cleanup', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ room_session_id: sessionId, mask_image_url }) }), { cleaned_room_image_url } = await cleanupRes.json(); currentRoomImageUrl = cleaned_room_image_url; roomImage.src = cleaned_room_image_url } catch (error) { console.error('Cleanup failed:', error); alert('Failed to clean room. Please try again.') } }); resetRoomBtn && resetRoomBtn.addEventListener('click', () => { if (originalRoomImageUrl) { currentRoomImageUrl = originalRoomImageUrl; roomImage.src = originalRoomImageUrl } }); scaleSlider && scaleValue && scaleSlider.addEventListener('input', e => { currentScale = parseFloat(e.target.value); scaleValue.textContent = currentScale.toFixed(1); applyTransform() }); adjustPlacementBtn && adjustPlacementBtn.addEventListener('click', () => { $('see-it-step-3').classList.add('hidden'); $('see-it-step-2').classList.remove('hidden'); resultDiv.innerHTML = ''; errorDiv.classList.add('hidden'); actionsDiv.classList.add('hidden'); statusText.textContent = 'Generating...' }); retryBtn && retryBtn.addEventListener('click', () => { if (lastPlacementPayload) { errorDiv.classList.add('hidden'); retryBtn.classList.add('hidden'); statusText.textContent = 'Retrying...'; resultDiv.innerHTML = ''; fetch('/apps/see-it/render', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(lastPlacementPayload) }).then(res => res.json()).then(data => pollStatus(data.jobId)).catch(err => { console.error(err); showError('Error starting retry') }) } }); const dragStart = e => { if (e.target === productImage) { initialX = e.clientX - xOffset; initialY = e.clientY - yOffset; isDragging = true } }, dragEnd = () => { initialX = currentX; initialY = currentY; isDragging = false }, drag = e => { if (isDragging) { e.preventDefault(); currentX = e.clientX - initialX; currentY = e.clientY - initialY; xOffset = currentX; yOffset = currentY; setTranslate(currentX, currentY, productImage) } }; container.addEventListener('mousedown', dragStart); container.addEventListener('mouseup', dragEnd); container.addEventListener('mousemove', drag); generateBtn && generateBtn.addEventListener('click', () => { $('see-it-step-2').classList.add('hidden'); $('see-it-step-3').classList.remove('hidden'); const rect = productImage.getBoundingClientRect(), containerRect = container.getBoundingClientRect(), relativeX = (rect.left - containerRect.left) / containerRect.width, relativeY = (rect.top - containerRect.top) / containerRect.height, stylePreset = $('see-it-style-preset').value, payload = { room_session_id: sessionId, product_id: trigger.dataset.productId, placement: { x: relativeX, y: relativeY, scale: currentScale }, config: { style_preset: stylePreset, quality: 'standard' } }; lastPlacementPayload = payload; fetch('/apps/see-it/render', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }).then(res => res.json()).then(data => pollStatus(data.jobId)).catch(err => { console.error(err); showError('Error starting render') }) }) });
