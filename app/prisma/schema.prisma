// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

model Shop {
  id              String         @id @default(uuid())
  shopDomain      String         @unique @map("shop_domain")
  shopifyShopId   String         @map("shopify_shop_id")
  accessToken     String         @map("access_token")
  plan            String
  monthlyQuota    Int            @map("monthly_quota")
  dailyQuota      Int            @map("daily_quota")
  createdAt       DateTime       @default(now()) @map("created_at")
  uninstalledAt   DateTime?      @map("uninstalled_at")

  productAssets   ProductAsset[]
  roomSessions    RoomSession[]
  renderJobs      RenderJob[]
  usageDaily      UsageDaily[]

  @@map("shops")
}

model ProductAsset {
  id               String      @id @default(uuid())
  shopId           String      @map("shop_id")
  productId        String      @map("product_id")
  variantId        String?     @map("variant_id")
  sourceImageId    String      @map("source_image_id")
  sourceImageUrl   String      @map("source_image_url")
  preparedImageUrl String?     @map("prepared_image_url")
  status           String      // "pending" | "ready" | "failed" | "stale" | "orphaned"
  prepStrategy     String      @map("prep_strategy") // "batch" | "fallback" | "manual"
  promptVersion    Int         @map("prompt_version")
  createdAt        DateTime    @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  shop             Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)
  renderJobs       RenderJob[]

  @@index([shopId, productId])
  @@map("product_assets")
}

model RoomSession {
  id                   String      @id @default(uuid())
  shopId               String      @map("shop_id")
  originalRoomImageUrl String?     @map("original_room_image_url")
  cleanedRoomImageUrl  String?     @map("cleaned_room_image_url")
  createdAt            DateTime    @map("created_at")
  expiresAt            DateTime    @map("expires_at")
  lastUsedAt           DateTime?   @map("last_used_at")

  shop                 Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)
  renderJobs           RenderJob[]

  @@map("room_sessions")
}

model RenderJob {
  id               String        @id @default(uuid())
  shopId           String        @map("shop_id")
  productId        String        @map("product_id")
  variantId        String?       @map("variant_id")
  productAssetId   String?       @map("product_asset_id")
  roomSessionId    String?       @map("room_session_id")
  placementX       Float         @map("placement_x")
  placementY       Float         @map("placement_y")
  placementScale   Float         @map("placement_scale")
  stylePreset      String?       @map("style_preset")
  quality          String?       @map("quality")
  configJson       String?       @map("config_json") // Stored as JSON string in SQLite
  status           String        // "queued" | "processing" | "completed" | "failed"
  imageUrl         String?       @map("image_url")
  modelId          String?       @map("model_id")
  promptId         String?       @map("prompt_id")
  promptVersion    Int?          @map("prompt_version")
  errorCode        String?       @map("error_code")
  errorMessage     String?       @map("error_message")
  createdAt        DateTime      @map("created_at")
  completedAt      DateTime?     @map("completed_at")

  shop             Shop          @relation(fields: [shopId], references: [id], onDelete: Cascade)
  productAsset     ProductAsset? @relation(fields: [productAssetId], references: [id])
  roomSession      RoomSession?  @relation(fields: [roomSessionId], references: [id])

  @@map("render_jobs")
}

model UsageDaily {
  id               String   @id @default(uuid())
  shopId           String   @map("shop_id")
  date             DateTime
  prepRenders      Int      @default(0) @map("prep_renders")
  cleanupRenders   Int      @default(0) @map("cleanup_renders")
  compositeRenders Int      @default(0) @map("composite_renders")

  shop             Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, date])
  @@map("usage_daily")
}
