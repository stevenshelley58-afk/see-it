# Theme Extension Frontend

## Shopper Flows

### Entry

- Theme app extension renders a See It block on the PDP.
- Button click opens a fullscreen or modal overlay while keeping the shopper on the PDP.

### Step 1: Capture

1. Shopper uploads or captures a room photo inside the modal.
2. Widget calls `POST /app-proxy/room/start` with the product GID to receive `room_session_id`, `upload_url`, and `room_image_future_url`.
3. Frontend uploads the binary directly to the presigned `upload_url`.
4. Widget calls `POST /app-proxy/room/confirm` with the `room_session_id` to lock in the original room image URL.

### Step 2: Edit Room

- **MVP:** Display the captured room image and provide “Continue” only; no cleanup occurs.
- **Later phases:** Support crop/rotate (client-side, reuploading via the same session) and erase-tool workflows:
  - Shopper draws a mask; frontend uploads mask to storage.
  - Widget calls `POST /app-proxy/room/cleanup` with `room_session_id` and `mask_url`.
  - Backend updates `cleaned_room_image_url`; subsequent steps use the cleaned image.
- Provide “Reset room” to drop back to the original URL.

### Step 3: Place and Adjust Product

- Fetch prepared product PNG (via metafield default or app response).
- Render ghost overlay (transparent PNG) above the room image layer.
- **MVP:** Drag-only positioning; lock `placement.scale = 1`.
- **Future:** Add resize (scale slider/pinch) and optional rotation.
- When shopper clicks “Generate”, build the payload for `POST /app-proxy/render` using normalized coordinates (0–1 range relative to the rendered room dimensions).

### Step 4: Generate and Review

1. Trigger `POST /app-proxy/render` with placement and config from step 3.
2. Start polling `GET /app-proxy/render/:job_id` until status becomes `completed` or `failed`.
3. On success, display the composite image and expose controls:
   - Close the modal.
   - Adjust placement (loop back to step 3).
   - Try a different room (return to capture).
   - Optional “Add to cart” or similar actions.
4. On failure, surface inline errors and offer retry or back navigation.

## API Interactions

- `POST /app-proxy/room/start` → request room session & upload URL.
- Presigned upload PUT/POST to object storage.
- `POST /app-proxy/room/confirm` → mark upload complete.
- `POST /app-proxy/room/cleanup` (future) → request cleaned image.
- `POST /app-proxy/render` → enqueue composite render.
- `GET /app-proxy/render/:job_id` → poll job status.
- All shapes and auth rules described in `04_API_CONTRACTS.md`.

## Upload Handling

- Use the presigned `upload_url` for direct binary upload; do not proxy through the Shopify app.
- Capture or derived assets should follow storage layout documented in `02_ARCHITECTURE.md`.
- Mask uploads (future) follow the same pattern with URLs provided out-of-band or generated by the backend.

## Ghost Overlay Structure

- Two-layer canvas or absolute-position stack:
  - Base layer: current room image (original or cleaned).
  - Top layer: prepared product PNG with transparency.
- Apply CSS transforms to the overlay to reflect placement values.
- Maintain consistent aspect ratios to avoid stretching the ghost asset.

## Interaction Rules

### Drag and Resize Mapping

- Track pointer/mouse/touch movement.
- Calculate normalized `x` and `y` by dividing the offset by the **displayed** element dimensions (CSS width/height).
- **Crucial**: Ensure the aspect ratio of the container matches the **intrinsic** aspect ratio of the room image to prevent coordinate drift during the backend composite step.
- `scale` represents relative size compared to the prepared PNG’s native dimensions.
- Rotation is deferred; keep runtime structures ready for an optional `rotation` field.

### Mobile Guidelines

- Apply `touch-action: none` on the overlay interaction layer to ensure gestures reach the widget.
- Disable browser zoom during pinch interactions; interpret pinches as scale adjustments when the feature lands.
- Ensure buttons and drag handles meet mobile hit-target requirements.

